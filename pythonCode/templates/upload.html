<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ ë° ì—°ë„ ë¶„ì„ ì—…ë¡œë”</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        #uploadForm { display: flex; flex-direction: column; gap: 15px; }
        label { font-weight: 600; color: #555; }
        input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        #uploadButton { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        #uploadButton:hover { background-color: #0056b3; }
        #statusMessage { margin-top: 20px; padding: 15px; border-radius: 4px; font-weight: bold; border: 1px solid #ccc; background-color: #e9ecef; }
        #descriptionOutput { margin-top: 20px; padding: 15px; border-left: 5px solid #28a745; background-color: #e6ffed; font-size: 1.1em;
            white-space: pre-wrap; }
        #imagePreviewContainer {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed #ccc;
            text-align: center;
            min-height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fafafa;
        }
        #imagePreview { 
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ–¼ï¸ ì´ë¯¸ì§€ ë° ì—°ë„ ë¶„ì„ ìš”ì²­</h2>
        
        <div id="uploadForm">
            <label for="imageFile">1. ë¶„ì„í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”:</label>
            <input type="file" id="imageFile" accept="image/*">
            
            <label for="imageYear">2. ì—°ë„ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1592):</label>
            <input type="number" id="imageYear" placeholder="4ìë¦¬ ì—°ë„" min="1000" max="9999" required>
            
            <button id="uploadButton">ì´ë¯¸ì§€ ë° ì—°ë„ ì „ì†¡</button>
        </div>
    
        <div id="statusMessage">íŒŒì¼ì„ ì„ íƒí•˜ê³  ì—°ë„ë¥¼ ì…ë ¥í•œ í›„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    
        <div id="imagePreviewContainer"> 
            <img id="imagePreview" src="#" alt="ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€">
            <span id="previewPlaceholder">ì„ íƒëœ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
        </div>

        <div id="descriptionOutput">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <script>
        // ë°±ì—”ë“œ API ì£¼ì†Œì™€ ì—”ë“œí¬ì¸íŠ¸ ì—¬ê¸°ì— ë§ê²Œ ìˆ˜ì •
        const API_ENDPOINT = '/upload'; 

        const fileInput = document.getElementById('imageFile');
        const yearInput = document.getElementById('imageYear'); // ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ì—°ë„ ì…ë ¥ í•„ë“œ
        const uploadButton = document.getElementById('uploadButton');
        const statusMessage = document.getElementById('statusMessage');
        const descriptionOutput = document.getElementById('descriptionOutput');
        const imagePreview = document.getElementById('imagePreview');
        const previewPlaceholder = document.getElementById('previewPlaceholder');

        uploadButton.addEventListener('click', handleUpload);
        fileInput.addEventListener('change', handleFileChange);
        
        function handleFileChange(event) {
            const file = event.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    previewPlaceholder.style.display = 'none';
                };
                reader.readAsDataURL(file); // íŒŒì¼ì„ Data URLë¡œ ì½ê¸°
            } else {
                // íŒŒì¼ ì„ íƒ ì·¨ì†Œ ì‹œ ì´ˆê¸° ìƒíƒœë¡œ ë³µêµ¬
                imagePreview.src = '#';
                imagePreview.style.display = 'none';
                previewPlaceholder.style.display = 'block';
            }
        }

        async function handleUpload() {
            // ì´ˆê¸° ìƒíƒœ ë° ë©”ì‹œì§€ ì´ˆê¸°í™”
            descriptionOutput.textContent = 'ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
            descriptionOutput.style.borderLeftColor = '#28a745';
            descriptionOutput.style.backgroundColor = '#e6ffed';

            const file = fileInput.files[0];
            const year = yearInput.value.trim(); // ì—°ë„ ê°’ ì¶”ì¶œ

            if (!file || !year || year.length !== 4) {
                statusMessage.textContent = 'ğŸ›‘ íŒŒì¼ê³¼ 4ìë¦¬ ì—°ë„ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.';
                statusMessage.style.backgroundColor = 'yellow';
                return;
            }

            // ì—…ë¡œë“œ ì‹œì‘ ì‹œ ìƒíƒœ í‘œì‹œ
            statusMessage.textContent = `ğŸš€ íŒŒì¼ "${file.name}" ë° ì—°ë„ ${year} ë¶„ì„ ìš”ì²­ ì¤‘...`;
            statusMessage.style.backgroundColor = 'lightblue';

            // 1. íŒŒì¼ ì „ì†¡ì„ ìœ„í•œ FormData ê°ì²´ ìƒì„±
            const formData = new FormData();
            
            // â­ íŒŒì¼ê³¼ ì—°ë„ ì •ë³´ë¥¼ FormDataì— ì¶”ê°€
            formData.append('image', file); // ë°±ì—”ë“œ í‚¤: image
            formData.append('year', year);   // ë°±ì—”ë“œ í‚¤: year

            try {
                // 2. fetch APIë¥¼ ì‚¬ìš©í•´ ë°±ì—”ë“œì— POST ìš”ì²­ ì „ì†¡
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: formData,
                });

                // 3. ì‘ë‹µ ì²˜ë¦¬
                if (response.ok) {
                    const result = await response.json();
                    
                    //ë°±ì—ì„œ is_successfulì˜ booleanê°’ì„ ì „ë‹¬í•˜ë©´ë¨. true ì´ë©´ í‹€ë¦¬ì§€ ì•Šì€ê±° false ì´ë©´ í‹€ë¦°ê²ƒ.
                    const isSuccessful = result.is_successful === true;
                    const imageDescription = result.description || "ë°±ì—”ë“œì—ì„œ ìœ íš¨í•œ ì„¤ëª…ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";

                    statusMessage.textContent = 'âœ… ì—…ë¡œë“œ ë° ë¶„ì„ ì„±ê³µ!';
                    statusMessage.style.backgroundColor = 'lightgreen';
                    
                    if (!isSuccessful) {
                        descriptionOutput.style.backgroundColor = 'lightcoral';
                        descriptionOutput.style.borderLeftColor = 'red';
                    }
                    if (result.image_data) {
                        imagePreview.src = "data:image/jpeg;base64," + result.image_data;
                        imagePreview.style.display = 'block';
                        previewPlaceholder.style.display = 'none';
                    }
                    // 4. ì¶”ì¶œí•œ ì„¤ëª…ì„ í™”ë©´ì— í‘œì‹œ
                    descriptionOutput.innerHTML = `
                        <strong>[ìš”ì²­ ì—°ë„]</strong> ${year}ë…„<br>
                        <strong>[ë¶„ì„ ê²°ê³¼]</strong> ${imageDescription}
                    `; 
                    
                    console.log('ë°±ì—”ë“œ ì‘ë‹µ ì „ì²´:', result);

                } else {
                    // HTTP ìƒíƒœ ì½”ë“œ 4xx, 5xx ì—ëŸ¬ ì²˜ë¦¬
                    const errorText = await response.text();
                    statusMessage.textContent = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨. ì½”ë“œ: ${response.status}. ë°±ì—”ë“œ ì‘ë‹µ: ${errorText}`;
                    statusMessage.style.backgroundColor = 'lightcoral';
                    descriptionOutput.textContent = 'ì´ë¯¸ì§€ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
                    descriptionOutput.style.backgroundColor = 'lightcoral';
                    descriptionOutput.style.borderLeftColor = 'red';
                }
            } catch (error) {
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (ì˜ˆ: ì„œë²„ ì—°ê²° ì•ˆ ë¨, CORS ë¬¸ì œ)
                statusMessage.textContent = `ìƒíƒœ: ğŸ’¥ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”. (${error.message})`;
                statusMessage.style.backgroundColor = 'lightcoral';
                descriptionOutput.textContent = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜ë¡œ ì„œë²„ì— ì ‘ì†í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                descriptionOutput.style.backgroundColor = 'lightcoral';
                descriptionOutput.style.borderLeftColor = 'red';
                console.error('Fetch Error:', error);
            }
        }
    </script>
</body>
</html>